<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>MISO : Installing MISO on baremetal</title>
        <meta name="description" content="An open-source LIMS for NGS sequencing centres">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/miso-lims/latest/css/syntax.css">
        <link rel="stylesheet" href="/miso-lims/latest/css/main.css">
				<link rel="icon" href="/miso-lims/latest/favicon.ico" type="image/x-icon">
    </head>
    <body>
<a href="https://github.com/miso-lims/miso-lims"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
        <div class="container">
            <div class="row">
                <div id="header" class="col-sm-12">
                    <h2><a class="brand" href="/miso-lims/latest/"><img src="/miso-lims/latest/images/MISO.png" alt="MISO's logo, a bowl of miso soup"/>MISO</a>
    <small>An open-source LIMS for NGS sequencing centres</small>
</h2>

                </div>
            </div>

            <div class="row">
                
                
                    <div id="navigation" class="col-sm-2">
                        <ul class="nav nav-list">
    <!--<li><a href="/miso-lims/latest/">Home</a></li>-->
    
        
        

        
    
        
        

        
            
                <li class="nav-header">User Guides</li>
            
            <li data-order="1"><a href="/miso-lims/latest/usr/user-manual-table-of-contents.html">User Manual</a></li>
        
    
        
        

        
            
                <li class="nav-header">Admin Guides</li>
            
            <li data-order="2"><a href="/miso-lims/latest/adm/baremetal-installation-guide.html">Installing MISO on baremetal</a></li>
        
            
            <li data-order="2"><a href="/miso-lims/latest/adm/compose-installation-guide.html">Installing MISO with docker-compose</a></li>
        
            
            <li data-order="2"><a href="/miso-lims/latest/adm/admin-guide.html">Administrator's Manual</a></li>
        
            
            <li data-order="1"><a href="/miso-lims/latest/adm/installation-guide.html">Building and Deploying</a></li>
        
    
        
        

        
            
                <li class="nav-header">Developer Guides</li>
            
            <li data-order="2"><a href="/miso-lims/latest/dev/rest-testing.html">REST Testing</a></li>
        
            
            <li data-order="2"><a href="/miso-lims/latest/dev/maven-artifacts.html">Maven artifacts</a></li>
        
            
            <li data-order="2"><a href="/miso-lims/latest/dev/eclipse-code-formatting.html">Eclipse Code Formatting</a></li>
        
            
            <li data-order="2"><a href="/miso-lims/latest/dev/code-style.html">Code Style</a></li>
        
            
            <li data-order="1"><a href="/miso-lims/latest/dev/developers-manual.html">Developer's Manual</a></li>
        
    
        
        

        
    
        
        

        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class="divider"></li> first to break up the content. -->
</ul>

                    </div>

                    <div id="content" class="col-sm-10">
                        <div class="page-header">
    <h2>Installing MISO on baremetal
        
    </h2>
</div>

<p>This installation guide is intended to be used if you cannot use Docker and
Docker compose, and is not trivial to set up. We recommend using Docker compose
if possible by following the
<a href="compose-installation-guide">Docker compose installation guide</a>.</p>

<p><a name="prerequisites"></a></p>

<h2 id="prerequisites">Prerequisites</h2>
<p>For each service, which may be put on the same machine, the following tools are
required:</p>

<p>Application Server:</p>

<ul>
  <li>JDK 8</li>
  <li>Tomcat 8</li>
</ul>

<p>Database Server:</p>

<ul>
  <li>MySQL 5.7.7 or MariaDB 10.2</li>
  <li><a href="https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/5.2.4/">Flyway 5.2.4</a> (newer versions may cause issues)</li>
</ul>

<p>Development Machine(s):</p>

<ul>
  <li>Maven</li>
  <li>git</li>
  <li>Eclipse</li>
  <li>A merge tool such as Meld</li>
</ul>

<p><a id="latest-release"></a></p>

<h2 id="downloading-the-latest-release">Downloading the latest release</h2>
<p>Use the GitHub interface to download the <a href="https://github.com/miso-lims/miso-lims/releases/latest">latest release</a>.
Extract the <code class="highlighter-rouge">.zip</code> or <code class="highlighter-rouge">.tar.gz</code> file.</p>

<p>Proceed to set up a build environment.</p>

<h1 id="setting-up-the-build-environment">Setting Up the Build Environment</h1>
<p>One or more machines should be set up to build MISO. A typical Linux system will
work; a typical Mac system may work. MISO is not guaranteed to work on Windows.</p>

<p>You will need:</p>

<ul>
  <li>JDK 8.0</li>
  <li><a href="http://maven.apache.org/download.html">Maven 3.0.5</a> or later</li>
  <li>Git</li>
</ul>

<p>For development purposes, Eclipse is recommended and it might be useful to set
up the server environments for testing. There is an automatic code formatting
configuration available for Eclipse.</p>

<h2 id="setting-up-the-database-server">Setting Up the Database Server</h2>
<p>The database server needs to have <a href="https://www.mysql.com/">MySQL 5.7</a>. The tool
<a href="https://flywaydb.org/">Flyway</a> must also be present to migrate the database as
the application is developed, but it can be installed on a different server so
long as it can access the database server.</p>

<p>The default password in the following <code class="highlighter-rouge">IDENTIFIED BY</code> clauses should be
changed.</p>

<p>Once installed, start the MySQL console and create the database:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE DATABASE lims;
USE lims;
</code></pre></div></div>

<p>Then add a user that has all grant access on the ‘lims’ db:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE USER 'tgaclims'@'localhost' IDENTIFIED BY 'tgaclims';
GRANT ALL ON `lims`.* TO 'tgaclims'@'localhost';
</code></pre></div></div>

<p>If your database and Tomcat install are on different machines, then you will
need to add a grant privilege to the MISO database from your remote machine:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GRANT ALL ON `lims`.* TO 'tgaclims'@'your.tomcat.install.server';
GRANT ALL ON `lims`.* TO 'tgaclims'@'your.tomcat.install.server' IDENTIFIED BY 'tgaclims';
</code></pre></div></div>

<p><a id="root"></a></p>

<h1 id="setting-up-the-application-server">Setting Up the Application Server</h1>

<p>Download the <a href="https://flywaydb.org/download/community">Flyway command line tool</a> version 5.2.4 and install it.
Newer versions of Flyway may cause issues, and are not recommended.</p>

<p>The application server needs <a href="https://tomcat.apache.org/download-80.cgi">Tomcat 8</a>.</p>

<p>Create a file called <code class="highlighter-rouge">ROOT.xml</code> in the following directory
<code class="highlighter-rouge">$CATALINA_HOME/conf/Catalina/localhost</code>, creating the directory if necessary,
and populate it with the following information:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Context path="/ROOT" docBase="${catalina.home}/webapps/ROOT"&gt;
  &lt;Resources allowLinking="true"/&gt;
  &lt;Resource name="jdbc/MISODB" type="javax.sql.DataSource"
  driverClassName="com.mysql.jdbc.Driver"
  initialSize="32"
  maxIdle="10"
  maxActive="100"
  maxWait="1000"
  removeAbandoned="true"
  removeAbandonedTimeout="120"
  logAbandoned="true"
  testWhileIdle="true"
  testOnBorrow="true"
  testOnReturn="true"
  validationQuery="select 1"
  url="jdbc:mysql://localhost:3306/lims?autoReconnect=true&amp;amp;zeroDateTimeBehavior=convertToNull&amp;amp;useUnicode=true&amp;amp;characterEncoding=UTF-8"
  username="tgaclims"
  password="tgaclims"/&gt;
  &lt;Parameter name="miso.propertiesFile" value="file:${catalina.home}/conf/Catalina/localhost/miso.properties" override="false"/&gt;
&lt;/Context&gt;
</code></pre></div></div>

<p>Make sure the database path in <code class="highlighter-rouge">ROOT.xml</code> is correct for your install:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>url="jdbc:mysql://your.database.server:3306/lims"
</code></pre></div></div>

<p>If your Tomcat install has the <code class="highlighter-rouge">autoDeploy="true"</code> flag set in <code class="highlighter-rouge">server.xml</code>, if
you delete the <code class="highlighter-rouge">webapps/ROOT</code> directory and the <code class="highlighter-rouge">ROOT.war</code> file, Tomcat will
delete the context <code class="highlighter-rouge">ROOT.xml</code> file. Either set autoDeploy to false, and
manually deploy your webapp, or make the <code class="highlighter-rouge">ROOT.xml</code> file undeletable by using
<code class="highlighter-rouge">chattr +i</code> (<code class="highlighter-rouge">chattr -i</code> will undo this operation). <a href="https://issues.apache.org/bugzilla/show_bug.cgi?id=40050">Upstream
bug</a></p>

<p>Copy <code class="highlighter-rouge">$MISO_SRC/miso-web/src/main/resources/miso.properties</code> to
<code class="highlighter-rouge">$CATALINA_HOME/conf/Catalina/localhost/miso.properties</code>. Review and edit
this file as appropriate (see <a href="#naming-schemes">Naming Schemes</a> below).</p>

<ul>
  <li>The naming schemes will determine how MISO checks if object names (especially
samples, libraries) are valid. If you do not want to use one of the supplied
ones (default standard, OICR’s standard, or no checks), you will have to write
one or more specific to your organisation. See <a href="#naming-schemes">Naming Schemes</a>
below for more information.</li>
  <li>Optional: If using any bulk barcode scanners (only VisionMate is supported at present),
define <code class="highlighter-rouge">miso.visionmate.servers</code> as specified in the properties file</li>
  <li>Optional: Update <code class="highlighter-rouge">miso.bugUrl</code> to the URL for your internal issue tracker or other
method for users to report issues using the “Report a problem” link in the header.</li>
  <li>Update <code class="highlighter-rouge">miso.instanceName</code> to update the instance name displayed in the header.</li>
</ul>

<p>Download some supporting JARs:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd $CATALINA_HOME/lib
curl -O https://search.maven.org/remotecontent?filepath=mysql/mysql-connector-java/5.1.10/mysql-connector-java-5.1.10.jar
curl -O https://artifacts.oicr.on.ca/artifactory/gsi-dependencies/uk/ac/ebi/fgpt/jndi-file-factory/1.0/jndi-file-factory-1.0.jar
</code></pre></div></div>

<p>Append the following line to <code class="highlighter-rouge">$CATALINA_HOME/bin/setenv.sh</code> or, if you installed Tomcat through apt, <code class="highlighter-rouge">/etc/default/tomcat8</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JAVA_OPTS="$JAVA_OPTS -Dsecurity.method=jdbc -Xmx768M"
</code></pre></div></div>

<p>(Update the security method if you are using LDAP or Active Directory LDAP.)</p>

<p>Create the directory <code class="highlighter-rouge">/storage/miso</code> and subdirectories <code class="highlighter-rouge">/storage/miso/log</code> and <code class="highlighter-rouge">/storage/miso/files</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir -p /storage/miso/log
mkdir -p /storage/miso/files
</code></pre></div></div>

<p>Ensure that the user that Tomcat runs as has write permission to the storage directory. For example, if the user is in the ‘tomcat’ group:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chgrp -R tomcat /storage/miso/
</code></pre></div></div>

<p>Move the following configuration files from <code class="highlighter-rouge">miso-lims/miso-web/src/main/resources</code> into
the <code class="highlighter-rouge">/storage/miso/</code> directory:</p>

<table>
  <thead>
    <tr>
      <th>File</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">security.properties</code></td>
      <td>properties to set the security environment (see below).</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">submission.properties</code></td>
      <td>properties to set the submission environment.</td>
    </tr>
  </tbody>
</table>

<h2 id="security-environment-updating-storagemisosecurityproperties">Security Environment (updating <code class="highlighter-rouge">/storage/miso/security.properties</code>)</h2>
<p>MISO can use either LDAP (<code class="highlighter-rouge">ldap</code>), Active Directory LDAP (<code class="highlighter-rouge">ad</code>), or JDBC
(<code class="highlighter-rouge">jdbc</code>) as an authentication mechanism. This is set by the <code class="highlighter-rouge">-Dsecurity.method</code>
noted in the previous section, and the same value must be set in <code class="highlighter-rouge">security.properties</code>.</p>

<p>If you are using JDBC (aka storing usernames and passwords in the database), set the
security method to <code class="highlighter-rouge">jdbc</code>.
No additional configuration is necessary.</p>

<p>For using LDAP, set the security method to <code class="highlighter-rouge">ldap</code>. Additional settings are
needed for LDAP in the <code class="highlighter-rouge">security.properties</code>. Talk to your LDAP administrator.</p>

<p>To use Active Directory, a specific kind of LDAP, set the security method to <code class="highlighter-rouge">ad</code>.
Some active directory settings are needed in addition to the LDAP settings in the
<code class="highlighter-rouge">security.properties</code> file.</p>

<p>The search for a user is done against <code class="highlighter-rouge">userPrincipalName</code> which takes the form of
an email address. To login the user will type their username and to do the lookup
their username will be added to the domain specified in the property
<code class="highlighter-rouge">security.ad.emailDomain</code>.</p>

<p>Use the <code class="highlighter-rouge">security.ad.url</code> property to indicate the url for the Active Directory.
Some valid examples are: <code class="highlighter-rouge">ad.oicr.on.ca</code>, <code class="highlighter-rouge">ldap://ad.oicr.on.ca:389</code> and
<code class="highlighter-rouge">ldaps://ad.oicr.on.ca:636</code>.</p>

<p>The groups used by MISO are <code class="highlighter-rouge">ROLE_INTERNAL</code> for regular users 
and <code class="highlighter-rouge">ROLE_ADMIN</code> for administrators. If you find these names
too general you may wish to add a prefix before adding these groups to your Active
Directory. For example <code class="highlighter-rouge">MISO_ROLE_INTERNAL</code> gives a clearer indication as to what
the group is used for. In this case you will need to set the property
<code class="highlighter-rouge">security.ldap.stripRolePrefix</code> to the value <code class="highlighter-rouge">MISO_</code> to allow MISO to ignore the
prefix.</p>

<p>If using JDBC, once running, you should change the passwords of the <code class="highlighter-rouge">admin</code> and
<code class="highlighter-rouge">notification</code> accounts.</p>

<p><a name="naming-schemes"></a></p>

<h2 id="naming-schemes-updating-catalina_homeconfcatalinalocalhostmisoproperties">Naming Schemes (updating <code class="highlighter-rouge">$CATALINA_HOME/conf/Catalina/localhost/miso.properties</code>)</h2>
<p>MISO Naming Schemes are used to validate and generate entity String fields. They are
used for all <code class="highlighter-rouge">name</code> fields, and some <code class="highlighter-rouge">alias</code> fields. You may configure a base naming
scheme, and customize it by switching validators and generators in <code class="highlighter-rouge">miso.properties</code> in
<code class="highlighter-rouge">$CATALINA_HOME/conf/Catalina/localhost/</code>.</p>

<p>The options for <code class="highlighter-rouge">miso.naming.scheme</code> are <code class="highlighter-rouge">default</code> and <code class="highlighter-rouge">oicr</code>, which have these
default configurations:</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>default</th>
      <th>oicr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Name generator</td>
      <td>DefaultNameGenerator</td>
      <td>DefaultNameGenerator</td>
    </tr>
    <tr>
      <td>Name Validator</td>
      <td>DefaultNameValidator</td>
      <td>DefaultNameValidator</td>
    </tr>
    <tr>
      <td>Sample Alias Generator</td>
      <td>none</td>
      <td>OicrSampleAliasGenerator</td>
    </tr>
    <tr>
      <td>Sample Alias Validator</td>
      <td>DefaultSampleAliasValidator</td>
      <td>OicrSampleAliasValidator</td>
    </tr>
    <tr>
      <td>Library Alias Generator</td>
      <td>DefaultLibraryAliasGenerator</td>
      <td>OicrLibraryAliasGenerator</td>
    </tr>
    <tr>
      <td>Library Alias Validator</td>
      <td>DefaultLibraryAliasValidator</td>
      <td>OicrLibraryAliasValidator</td>
    </tr>
    <tr>
      <td>Project ShortName Validator</td>
      <td>AllowAnythingValidator</td>
      <td>OicrProjectShortNameValidator</td>
    </tr>
    <tr>
      <td>Configurable components</td>
      <td>all</td>
      <td>none</td>
    </tr>
  </tbody>
</table>

<p>If the naming scheme you’ve selected has configurable components, you may configure them
as follows.</p>

<h3 id="misonaminggeneratornameablename"><code class="highlighter-rouge">miso.naming.generator.nameable.name</code></h3>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>default</td>
      <td>SAM1</td>
    </tr>
    <tr>
      <td>classname</td>
      <td>SampleImpl1</td>
    </tr>
  </tbody>
</table>

<h3 id="misonaminggeneratorsamplealias"><code class="highlighter-rouge">miso.naming.generator.sample.alias</code></h3>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Example</th>
      <th>Note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>oicr</td>
      <td>PROJ_0001_Ad_P_nn_1-1</td>
      <td>for use with DetailedSample only</td>
    </tr>
  </tbody>
</table>

<h3 id="misonaminggeneratorlibraryalias"><code class="highlighter-rouge">miso.naming.generator.library.alias</code></h3>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Example</th>
      <th>Note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>default</td>
      <td>XX_LYY-1</td>
      <td>XX and YY taken from sample alias - depends on sample alias passing default validator with default regex</td>
    </tr>
    <tr>
      <td>oicr</td>
      <td>PROJ_0001_Ad_P_PE_300_WG</td>
      <td>For use with DetailedSample only. Depends on sample alias passing oicr validator</td>
    </tr>
  </tbody>
</table>

<h3 id="misonamingvalidatornameablename"><code class="highlighter-rouge">miso.naming.validator.nameable.name</code></h3>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Detail</th>
      <th>Allow null</th>
      <th>Allow duplicates</th>
      <th>Custom Regex</th>
      <th>Custom Duplication</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>default</td>
      <td>Matches ‘default’ generator, or custom regex</td>
      <td>no</td>
      <td>no</td>
      <td>yes</td>
      <td>yes</td>
    </tr>
    <tr>
      <td>allowany</td>
      <td>Only checks that the name is not null</td>
      <td>no</td>
      <td>yes</td>
      <td>no</td>
      <td>no</td>
    </tr>
  </tbody>
</table>

<h3 id="misonamingvalidatorsamplealias"><code class="highlighter-rouge">miso.naming.validator.sample.alias</code></h3>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Detail</th>
      <th>Allow null</th>
      <th>Allow duplicates</th>
      <th>Custom Regex</th>
      <th>Custom Duplication</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>default</td>
      <td>Default regex: <code class="highlighter-rouge">([A-z0-9]+)_S([A-z0-9]+)_(.*)</code></td>
      <td>no</td>
      <td>no</td>
      <td>yes</td>
      <td>no</td>
    </tr>
    <tr>
      <td>allowany</td>
      <td>Only checks that the alias is not null</td>
      <td>no</td>
      <td>yes</td>
      <td>no</td>
      <td>no</td>
    </tr>
    <tr>
      <td>oicr</td>
      <td>Matches ‘oicr’ generator</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
    </tr>
  </tbody>
</table>

<h3 id="misonamingvalidatorlibraryalias"><code class="highlighter-rouge">miso.naming.validator.library.alias</code></h3>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Detail</th>
      <th>Allow null</th>
      <th>Allow duplicates</th>
      <th>Custom Regex</th>
      <th>Custom Duplication</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>default</td>
      <td>Matches ‘default’ generator</td>
      <td>no</td>
      <td>no</td>
      <td>yes</td>
      <td>no</td>
    </tr>
    <tr>
      <td>allowany</td>
      <td>Only checks that the alias is not null</td>
      <td>no</td>
      <td>yes</td>
      <td>no</td>
      <td>no</td>
    </tr>
    <tr>
      <td>oicr</td>
      <td>Matches ‘oicr’ generator</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
    </tr>
  </tbody>
</table>

<h3 id="misonamingvalidatorprojectshortname"><code class="highlighter-rouge">miso.naming.validator.project.shortName</code></h3>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Detail</th>
      <th>Allow null</th>
      <th>Allow duplicates</th>
      <th>Custom Regex</th>
      <th>Custom Duplication</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>allowany</td>
      <td>Optional field, no format specified</td>
      <td>yes</td>
      <td>yes</td>
      <td>no</td>
      <td>no</td>
    </tr>
    <tr>
      <td>oicr</td>
      <td>3-5 characters, CAPS and numbers only</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
    </tr>
  </tbody>
</table>

<p>If a validator accepts custom regex, it can be configured via <code class="highlighter-rouge">&lt;base property&gt;.regex</code>.
e.g. <code class="highlighter-rouge">miso.naming.validator.nameable.name.regex:.*</code> to allow any name. A custom validator
must be specified for this property to be enabled - the naming scheme’s default validator
will not be altered.</p>

<p>If a validator accepts custom duplication, that can be configured via
<code class="highlighter-rouge">&lt;base property&gt;.duplicates</code>. e.g. <code class="highlighter-rouge">miso.naming.validator.library.alias.duplicates:true</code>
to allow duplicate library aliases. A custom validator must be specified for this
property to be enabled - the naming scheme’s default validator will not be altered.</p>

<h1 id="setting-up-the-run-scanner">Setting Up the Run Scanner</h1>
<p><a href="https://github.com/oicr-gsi/runscanner">Run Scanner</a> is a webservice that scans the paths containing
sequencer output. It is not required for a functioning MISO install, but
without it, sequencer runs must be added manually.</p>

<p>Please see the Run Scanner readme for setup instructions.</p>

<p>Once complete, edit <code class="highlighter-rouge">$CATALINA_HOME/conf/Catalina/localhost/miso.properties</code> of the MISO Tomcat server and set <code class="highlighter-rouge">miso.runscanner.urls</code> to the URL of the Run Scanner instance. It is possible to set up multiple run scanners managing different sequencers and add all the URLs to <code class="highlighter-rouge">miso.properties</code>. If you are adding Run Scanner to a previously-established MISO environment, restart MISO.</p>

<h1 id="building-the-application">Building the Application</h1>

<p><code class="highlighter-rouge">cd</code> into <code class="highlighter-rouge">$MISO_SRC</code>.
Build the application using:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn clean package
</code></pre></div></div>

<p>There will be an important build artefact: <code class="highlighter-rouge">miso-web/target/ROOT.war</code></p>

<p><a name="upgrading"></a></p>

<h1 id="releasing-and-upgrading">Releasing and Upgrading</h1>

<p>Prior to release, ensure that you have followed the instructions in the
above and have WAR files for both MISO (<code class="highlighter-rouge">ROOT.war</code>) and, if desired, <a href="https://github.com/oicr-gsi/runscanner">Run Scanner</a>(<code class="highlighter-rouge">runscanner-*.war</code>).</p>

<p>To install or upgrade, perform the following steps:</p>

<ol>
  <li>Backup your existing database.</li>
  <li>Stop MISO’s Tomcat.</li>
  <li>Remove <code class="highlighter-rouge">$CATALINA_HOME/webapps/ROOT</code> directory and <code class="highlighter-rouge">$CATALINA_HOME/webapps/ROOT.war</code> file.</li>
  <li>Copy the <code class="highlighter-rouge">ROOT.war</code> from the build to <code class="highlighter-rouge">$CATALINA_HOME/webapps</code>.</li>
  <li>Make any necessary configuration changes to <code class="highlighter-rouge">$CATALINA_HOME/conf/Catalina/localhost/miso.properties</code>.</li>
  <li>Migrate the database to the newest version. (Described below.)</li>
  <li>If also releasing Run Scanner, deploy it:
    <ol>
      <li>Stop Run Scanner’s Tomcat.</li>
      <li>Deploy the Run Scanner WAR.</li>
      <li>Restart Run Scanner’s Tomcat.</li>
    </ol>
  </li>
  <li>Restart MISO’s Tomcat.</li>
</ol>

<h2 id="migrating-the-database">Migrating the database</h2>

<p>Updating the database (or setting it up initially) will apply patches to the database using Flyway using the <code class="highlighter-rouge">ROOT.war</code>.
The same path should be used for <code class="highlighter-rouge">MISO_FILES_DIR</code> as is set for <code class="highlighter-rouge">miso.fileStorageDirectory</code> in <code class="highlighter-rouge">miso.properties</code>
(<code class="highlighter-rouge">/storage/miso/files/</code> by default)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ${FLYWAY}
rm -f jars/sqlstore-*.jar
unzip -xjo $CATALINA_HOME/webapps/ROOT.war 'WEB-INF/lib/sqlstore-*.jar' -d jars
./flyway -user=$MISO_DB_USER -password=$MISO_DB_PASS -url=$MISO_DB_URL -outOfOrder=true -locations=classpath:db/migration,classpath:uk.ac.bbsrc.tgac.miso.db.migration migrate -placeholders.filesDir=${MISO_FILES_DIR}
</code></pre></div></div>

<p><code class="highlighter-rouge">$DB_URL</code> should be in the same format as in the <code class="highlighter-rouge">ROOT.xml</code>, except replacing <code class="highlighter-rouge">&amp;amp;</code> with just <code class="highlighter-rouge">&amp;</code>
and replacing <code class="highlighter-rouge">zeroDateTimeBehavior=convertToNull</code> with <code class="highlighter-rouge">zeroDateTimeBehavior=CONVERT_TO_NULL</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jdbc:mysql://localhost:3306/lims?autoReconnect=true&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useUnicode=true&amp;characterEncoding=UTF-8
</code></pre></div></div>

<details>
<summary>Click here if you have run into an issue with migration `V0320` with MariaDB:</summary>

This migration contains some syntax which is not compatible with MariaDB. You can skip over the `Printer` code at issue, and manually copy the remainder of the migration into the MySQL console (as seen below). The last command changes the Flyway state from failed to succeeded. You can then run Flyway again from the terminal and it will resume with the next migration.

```
CREATE TABLE PlatformSizes (
  platform_platformId bigint(20) NOT NULL,
  partitionSize int NOT NULL,
  PRIMARY KEY (platform_platformId, partitionSize),
  CONSTRAINT fk_platform_size_platform FOREIGN KEY (platform_platformId) REFERENCES Platform (platformId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO PlatformSizes(platform_platformId, partitionSize)
  SELECT DISTINCT platform, COUNT(*) AS c FROM SequencerPartitionContainer JOIN SequencerPartitionContainer_Partition ON containerId = container_containerId GROUP BY containerId
  UNION SELECT platformId, 1 FROM Platform WHERE name = 'ILLUMINA' AND instrumentModel LIKE '%MiSeq%'
  UNION SELECT platformId, 2 FROM Platform WHERE name = 'ILLUMINA' AND instrumentModel LIKE '%HiSeq%'
  UNION SELECT platformId, 8 FROM Platform WHERE name = 'ILLUMINA' AND instrumentModel LIKE '%HiSeq%'
  UNION SELECT platformId, 4 FROM Platform WHERE name = 'ILLUMINA' AND instrumentModel LIKE '%NextSeq%'
  UNION SELECT platformId, 4 FROM Platform WHERE name = 'ILLUMINA' AND instrumentModel LIKE '%Genome Analyzer%'
  UNION SELECT platformId, 1 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 2 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 3 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 4 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 5 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 6 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 7 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 8 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 9 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 10 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 11 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 12 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 13 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 14 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 15 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 16 FROM Platform WHERE name = 'PACBIO'
  UNION SELECT platformId, 1 FROM Platform WHERE name = 'LS454'
  UNION SELECT platformId, 2 FROM Platform WHERE name = 'LS454'
  UNION SELECT platformId, 4 FROM Platform WHERE name = 'LS454'
  UNION SELECT platformId, 8 FROM Platform WHERE name = 'LS454'
  UNION SELECT platformId, 16 FROM Platform WHERE name = 'LS454'
  UNION SELECT platformId, 6 FROM Platform WHERE name = 'SOLID' AND instrumentModel = 'AB SOLiD 5500xl'
  UNION SELECT platformId, 1 FROM Platform WHERE name = 'SOLID' AND instrumentModel &lt;&gt; 'AB SOLiD 5500xl'
  UNION SELECT platformId, 2 FROM Platform WHERE name = 'SOLID' AND instrumentModel &lt;&gt; 'AB SOLiD 5500xl'
  UNION SELECT platformId, 4 FROM Platform WHERE name = 'SOLID' AND instrumentModel &lt;&gt; 'AB SOLiD 5500xl'
  UNION SELECT platformId, 8 FROM Platform WHERE name = 'SOLID' AND instrumentModel &lt;&gt; 'AB SOLiD 5500xl'
  UNION SELECT platformId, 16 FROM Platform WHERE name = 'SOLID' AND instrumentModel &lt;&gt; 'AB SOLiD 5500xl'
;

CREATE TABLE PartitionQCType (
  partitionQcTypeId bigint(20) NOT NULL AUTO_INCREMENT,
  description varchar(255) NOT NULL,
  noteRequired boolean DEFAULT false,
  PRIMARY KEY (partitionQcTypeId),
  UNIQUE KEY uk_partitionqctype_description (description)
) ENGINE=InnoDB AUTO_INCREMENT=22 DEFAULT CHARSET=utf8;

CREATE TABLE Run_Partition_QC (
  runId bigint(20) NOT NULL,
  partitionId bigint(20) NOT NULL,
  partitionQcTypeId bigint(20) NOT NULL,
  notes varchar(1024),
  PRIMARY KEY(runId, partitionId),
  CONSTRAINT fk_rpq_run_runId FOREIGN KEY (runId) REFERENCES Run (runId),
  CONSTRAINT fk_rpq_partition_partitionId FOREIGN KEY (partitionId) REFERENCES _Partition (partitionId),
  CONSTRAINT fk_rpq_partitiontypeqc_partitiontypeqc FOREIGN KEY (partitionQcTypeId) REFERENCES PartitionQCType (partitionQcTypeId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO PartitionQCType(description, noteRequired) VALUES
  ('OK', false),
  ('OK\'d by collaborator', false),
  ('Failed: Instrument problem', false),
  ('Failed: Library preparation problem', false),
  ('Failed: Analysis problem', false),
  ('Failed: Other problem', true);
INSERT INTO PartitionQCType(description, noteRequired)
    SELECT CONCAT('Failed: ', name), true FROM QCType WHERE qcTarget = 'Run';
INSERT INTO Run_Partition_QC(runId, partitionId, partitionQcTypeId, notes)
  SELECT RunQC.run_runId, RunQC_Partition.partition_partitionId, partitionQcTypeId, information
  FROM RunQC
    JOIN RunQC_Partition ON RunQC.qcId = RunQC_Partition.runQc_runQcId
    JOIN QCType ON RunQC.qcMethod = QCType.qcTypeId
    JOIN PartitionQCType ON PartitionQCType.description = CONCAT('Failed :', QCType.name);
DROP TABLE RunQC_Partition;
DROP TABLE RunQC;
DELETE FROM QCType WHERE qcTarget = 'Run';


UPDATE flyway_schema_history SET success = 1 WHERE version = '0320';
```
</details>

<details>
<summary>Click here if you have run into an issue with migration `V0611`:</summary>

Ths command changes the Flyway state from failed to succeeded. You can then run Flyway again from the terminal and it will resume with the next migration.

    UPDATE flyway_schema_history SET success = 1 WHERE version = '0611';


</details>

<p>If you encounter other errors migrating the database, make sure that you are using the recommended version of Flyway (see
<a href="#prerequisites">Prerequisites</a>).</p>


                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="https://github.com/TGAC/miso-lims">MISO</a>

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>
        
    </body>
</html>
