<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>MISO : Administrator's Manual</title>
        <meta name="description" content="An open-source LIMS for NGS sequencing centres">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/miso-lims/styles/syntax.css">
        <link rel="stylesheet" href="/miso-lims/styles/main.css">
    </head>
    <body>
<a href="https://github.com/TGAC/miso-lims"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>


        <div class="container">
            <div class="row">
                <div id="header" class="col-sm-12">
                    <h2><a class="brand" href="/miso-lims/"><img src="/miso-lims/images/MISO.png"/>MISO</a>
    <small>An open-source LIMS for NGS sequencing centres</small>
</h2>
<span class="badge" style="position: relative;left:20px;bottom:20px;background:#8DBDD8;">Original</span>

                </div>
            </div>

            <div class="row">
                
                
                    <div id="navigation" class="col-sm-2">
                        <ul class="nav nav-list">
    <!--<li><a href="/miso-lims/">Home</a></li>-->
    <a href="/miso-lims/">Home</a>
    <hr>
    <a href="/miso-lims/manuals/admin-manual"><b>Admin's Manual</b></a>
        

        
            
                <li class="nav-header"></li>
            
            <li data-order=""><a href="/miso-lims/adm/external-webapp.html">Configuring the external webapp</a></li>
        
</ul>

                    </div>

                    <div id="content" class="col-sm-10">
                        <h2 id="running-a-miso-instance">Running a MISO Instance</h2>
<p>MISO requires some configuration directly in the source code. While we plan to
change this over time, running an instance of MISO will require building and
deploying a fork of the code base with customisations.</p>

<h2 id="prerequisites">Prerequisites</h2>
<p>For each service, which may be put on the same machine, the following tools are
required:</p>

<p>All:</p>

<ul>
  <li>JDK 7</li>
</ul>

<p>Application Server:</p>

<ul>
  <li>Tomcat 8</li>
</ul>

<p>Database Server:</p>

<ul>
  <li>mySQL 5</li>
  <li>Flyway</li>
</ul>

<p>Notification Server:</p>

<ul>
  <li>Nothing extra</li>
</ul>

<p>Development Machine(s):</p>

<ul>
  <li>Maven</li>
  <li>git</li>
  <li>Eclipse</li>
  <li>A merge tool such as Meld</li>
</ul>

<h2 id="creating-a-fork">Creating a Fork</h2>
<p>Use the GitHub interface or a private instance to create a forked repository.</p>

<p>Proceed to set up a build environment.</p>

<h2 id="setting-up-the-build-environment">Setting Up the Build Environment</h2>
<p>One or more machines should be set up to build MISO. A typical Linux system will
work.</p>

<p>You will need:</p>

<ul>
  <li>JDK 7.0</li>
  <li><a href="http://maven.apache.org/download.html">Maven 3.0.5</a> or later</li>
  <li>Git</li>
</ul>

<p>For development purposes, Eclipse is recommended and it might be useful to set
up the server environments for testing. There is an automatic code formatting
configuration available for Eclipse.</p>

<p>Locally, create a checkout:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>git clone you@server:your-miso.git
git remote add tgac git@github.com:TGAC/miso-lims.git
</code></pre>
</div>

<h2 id="setting-up-the-database-server">Setting Up the Database Server</h2>
<p>The database server needs to have <a href="https://www.mysql.com/">MySQL 5</a>. The tool
<a href="https://flywaydb.org/">Flyway</a> must also be present to migrate the database as
the application is developed, but it can be installed on a different server so
long as it can access the database server.</p>

<p>The default password in the following <code class="highlighter-rouge">IDENTIFIED BY</code> clauses should be
changed.</p>

<p>Once installed, start the MySQL console and create the database:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>CREATE DATABASE lims;
USE lims;
</code></pre>
</div>

<p>Then add a user that has all grant access on the ‘lims’ db:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>GRANT ALL ON `lims`.* TO 'tgaclims'@'localhost';
GRANT ALL ON `lims`.* TO 'tgaclims'@'localhost' IDENTIFIED BY 'tgaclims';
</code></pre>
</div>

<p>If your database and Tomcat install are on different machines, then you will
need to add a grant privilege to the MISO database from your remote machine:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>GRANT ALL ON `lims`.* TO 'tgaclims'@'your.tomcat.install.server';
GRANT ALL ON `lims`.* TO 'tgaclims'@'your.tomcat.install.server' IDENTIFIED BY 'tgaclims';
</code></pre>
</div>

<p>Download the Flyway command line tool and install it.</p>

<h2 id="setting-up-the-application-server">Setting Up the Application Server</h2>
<p>The application server needs <a href="https://tomcat.apache.org/download-80.cgi">Tomcat 8</a>.</p>

<p>Create a file called <code class="highlighter-rouge">ROOT.xml</code> in the following directory
<code class="highlighter-rouge">$CATALINA_HOME/conf/Catalina/localhost</code>, creating the directory if necessary,
and populate it with the following information:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;Context path="/ROOT" docBase="${catalina.home}/webapps/ROOT" debug="1"&gt;
  &lt;Resource name="jdbc/MISODB" type="javax.sql.DataSource"
  driverClassName="com.mysql.jdbc.Driver"
  initialSize="32"
  maxIdle="10"
  maxActive="100"
  maxWait="1000"
  removeAbandoned="true"
  removeAbandonedTimeout="120"
  logAbandoned="true"
  testWhileIdle="true"
  testOnBorrow="true"
  testOnReturn="true"
  validationQuery="select 1"
  url="jdbc:mysql://localhost:3306/lims?autoReconnect=true&amp;amp;zeroDateTimeBehavior=convertToNull&amp;amp;useUnicode=true&amp;amp;characterEncoding=UTF-8"
  username="tgaclims"
  password="tgaclims"/&gt;
  &lt;Parameter name="miso.propertiesFile" value="file:${CATALINA_HOME}/conf/Catalina/localhost/miso.properties" override="false"/&gt;
  &lt;Parameter name="miso.name" value="Test"/&gt;
&lt;/Context&gt;
</code></pre>
</div>

<p>Make sure the database path in <code class="highlighter-rouge">ROOT.xml</code> is correct for your install:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>url="jdbc:mysql://your.database.server:3306/lims"
</code></pre>
</div>

<p>Also, set the <code class="highlighter-rouge">miso.name</code> parameter to something to help distinguish testing
and production copies of MISO.</p>

<p>If your Tomcat install has the <code class="highlighter-rouge">autoDeploy="true"</code> flag set in <code class="highlighter-rouge">server.xml</code>, if
you delete the <code class="highlighter-rouge">webapps/ROOT</code> directory and the <code class="highlighter-rouge">ROOT.war</code> file, Tomcat will
delete the context <code class="highlighter-rouge">ROOT.xml</code> file. Either set autoDeploy to false, and
manually deploy your webapp, or make the <code class="highlighter-rouge">ROOT.xml</code> file undeletable by using
<code class="highlighter-rouge">chattr +i</code> (<code class="highlighter-rouge">chattr -i</code> will undo this operation). <a href="https://issues.apache.org/bugzilla/show_bug.cgi?id=40050">Upstream
bug</a></p>

<p>Copy <code class="highlighter-rouge">$MISO_SRC/miso-web/src/main/resources/external/miso.properties</code> to
<code class="highlighter-rouge">${CATALINA_HOME}/conf/Catalina/localhost/miso.properties</code>. Review and edit
this file as appropriate.</p>

<ul>
  <li>The naming schemes will determine how MISO checks if object names (especially
samples, libraries) are valid. If you do not want to use one of the supplied
ones (TGAC’s standard, OICR’s standard, or no checks), you will have to write
one or more specific to your organisation. See Naming Schemes below for more
information.</li>
  <li>If using a notification server, change <code class="highlighter-rouge">miso.notification.interop.enabled</code>
to <code class="highlighter-rouge">true</code> and change the host and port for your notification server
 (see Setting Up the Notification Server below).</li>
  <li>If using a bulk barcode scanner (only VisionMate is supported at present), 
set <code class="highlighter-rouge">miso.boxscanner.enabled</code> to <code class="highlighter-rouge">true</code> and change the host and port for your
VisionMate server.</li>
</ul>

<p>Download some supporting JARs:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd $CATALINA_HOME/lib
curl -O https://repos.tgac.ac.uk/miso/common/mysql-connector-java-5.1.10.jar
curl -O https://repos.tgac.ac.uk/miso/common/jndi-file-factory-1.0.jar
</code></pre>
</div>

<p>Append the following line to <code class="highlighter-rouge">$CATALINA_HOME/bin/setenv.sh</code> or, if using Tomcat from Debian or Ubuntu, <code class="highlighter-rouge">/etc/default/tomcat8</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>JAVA_OPTS="$JAVA_OPTS -Dsecurity.method=jdbc -Xmx768M"
</code></pre>
</div>

<p>Create the directory <code class="highlighter-rouge">/storage/miso</code> and download the default MISO configuration files.</p>

  	cd /storage/miso
<div class="highlighter-rouge"><pre class="highlight"><code>curl https://repos.tgac.ac.uk/miso/latest/miso_userspace_properties.tar.gz | tar xvfz -
</code></pre>
</div>

<p>The configuration files are:</p>

<table>
  <thead>
    <tr>
      <th>File</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">issuetracker.properties</code></td>
      <td>settings for an issue tracking system, such as JIRA or RT.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">mail.properties</code></td>
      <td>email settings so that MISO can send emails to users.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">security.properties</code></td>
      <td>properties to set the security environment (see below).</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">submission.properties</code></td>
      <td>properties to set the submission environment.</td>
    </tr>
  </tbody>
</table>

<h3 id="security-environment">Security Environment</h3>
<p>MISO can use either LDAP or JDBC as an authentication mechanism. The mechanism
is set in both <code class="highlighter-rouge">/storage/miso/security.properties</code> and the
<code class="highlighter-rouge">$CATALINA_HOME/bin/setenv.sh</code> or <code class="highlighter-rouge">/etc/default/tomcat8</code> files and both must be
the same.</p>

<p>If you are using JDBC (aka storing usernames and passwords in the database), set the 
security method to <code class="highlighter-rouge">jdbc</code>.
The default configuration should work properly.</p>

<p>For using LDAP, set the security method to <code class="highlighter-rouge">ldap</code>. Additional settings are
needed for LDAP in the <code class="highlighter-rouge">security.properties</code>. Talk to your LDAP administrator.</p>

<p>To use Active Directory, a specific kind of LDAP, set the security method to
<code class="highlighter-rouge">ad</code>. Three additional settings are needed for Active Directory in the 
<code class="highlighter-rouge">security.properties</code> file.</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">security.ad.emailDomain</code></td>
      <td>Domain added to username for lookup (e.g. ad.oicr.on.ca)</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">security.ad.url</code></td>
      <td>Url for Active Directory server (e.g. ldap://ad.oicr.on.ca)</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">security.ad.stripRolePrefix</code></td>
      <td>Prefix to be removed from group (e.g. MISO_)</td>
    </tr>
  </tbody>
</table>

<p>The search for a user is done against <code class="highlighter-rouge">userPrincipalName</code> which takes the form of
an email address. To login the user will type their username and to do the lookup
their username will be added to the domain specified in the property
<code class="highlighter-rouge">security.ad.emailDomain</code>.</p>

<p>Use the <code class="highlighter-rouge">security.ad.url</code> property to indicate the url for the Active Directory.
Some valid examples are: <code class="highlighter-rouge">ad.oicr.on.ca</code>, <code class="highlighter-rouge">ldap://ad.oicr.on.ca:389</code> and
<code class="highlighter-rouge">ldaps://ad.oicr.on.ca:636</code>.</p>

<p>The groups used by MISO are <code class="highlighter-rouge">ROLE_INTERNAL</code> for regular users, <code class="highlighter-rouge">ROLE_EXTERNAL</code> for
external collaborators and <code class="highlighter-rouge">ROLE_ADMIN</code> for administrators. If you find these names
too general you may wish to add a prefix before adding these groups to your Active
Directory. For example <code class="highlighter-rouge">MISO_ROLE_INTERNAL</code> gives a clearer indication as to what 
the group is used for. In this case you will need to set the property
<code class="highlighter-rouge">security.ad.stripRolePrefix</code> to the value <code class="highlighter-rouge">MISO_</code> to allow MISO to ignore the
prefix.</p>

<p>If using JDBC, once running, you should change the passwords of the <code class="highlighter-rouge">admin</code> and
<code class="highlighter-rouge">notification</code> accounts.</p>

<h3 id="naming-schemes">Naming Schemes</h3>
<p>MISO Naming Schemes are used to validate and generate entity String fields. They are
used for all <code class="highlighter-rouge">name</code> fields, and some <code class="highlighter-rouge">alias</code> fields. You may configure a base naming
scheme, and customize it by switching validators and generators in <code class="highlighter-rouge">miso.properties</code>.</p>

<p>The options for <code class="highlighter-rouge">miso.naming.scheme</code> are <code class="highlighter-rouge">default</code> and <code class="highlighter-rouge">oicr</code>, which have these
default configurations:</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>default</th>
      <th>oicr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Name generator</td>
      <td>DefaultNameGenerator</td>
      <td>DefaultNameGenerator</td>
    </tr>
    <tr>
      <td>Name Validator</td>
      <td>DefaultNameValidator</td>
      <td>DefaultNameValidator</td>
    </tr>
    <tr>
      <td>Sample Alias Generator</td>
      <td>none</td>
      <td>OicrSampleAliasGenerator</td>
    </tr>
    <tr>
      <td>Sample Alias Validator</td>
      <td>DefaultSampleAliasValidator</td>
      <td>OicrSampleAliasValidator</td>
    </tr>
    <tr>
      <td>Library Alias Generator</td>
      <td>DefaultLibraryAliasGenerator</td>
      <td>none</td>
    </tr>
    <tr>
      <td>Library Alias Validator</td>
      <td>DefaultLibraryAliasValidator</td>
      <td>OicrLibraryAliasValidator</td>
    </tr>
    <tr>
      <td>Project ShortName Validator</td>
      <td>AllowAnythingValidator</td>
      <td>OicrProjectShortNameValidator</td>
    </tr>
    <tr>
      <td>Configurable components</td>
      <td>all</td>
      <td>none</td>
    </tr>
  </tbody>
</table>

<p>If the naming scheme you’ve selected has configurable components, you may configure them
as follows.</p>

<h4 id="misonaminggeneratornameablename"><code class="highlighter-rouge">miso.naming.generator.nameable.name</code></h4>

<table>
  <tbody>
    <tr>
      <td>Option</td>
      <td>Example</td>
    </tr>
    <tr>
      <td>default</td>
      <td>SAM1</td>
    </tr>
    <tr>
      <td>classname</td>
      <td>SampleImpl1</td>
    </tr>
  </tbody>
</table>

<h4 id="misonaminggeneratorsamplealias"><code class="highlighter-rouge">miso.naming.generator.sample.alias</code></h4>

<table>
  <tbody>
    <tr>
      <td>Option</td>
      <td>Example</td>
      <td>Note</td>
    </tr>
    <tr>
      <td>oicr</td>
      <td>PROJ_0001_Ad_P_nn_1-1</td>
      <td>for use with DetailedSample only</td>
    </tr>
  </tbody>
</table>

<h4 id="misonaminggeneratorlibraryalias"><code class="highlighter-rouge">miso.naming.generator.library.alias</code></h4>

<table>
  <tbody>
    <tr>
      <td>Option</td>
      <td>Example</td>
      <td>Note</td>
    </tr>
    <tr>
      <td>default</td>
      <td>XX_LYY-1</td>
      <td>XX and YY taken from sample alias - depends on sample alias passing default validator with default regex</td>
    </tr>
    <tr>
      <td>oicr</td>
      <td>PROJ_0001_Ad_P_PE_300_WG</td>
      <td>for use with DetailedSample only. depends on sample alias passing oicr validator</td>
    </tr>
  </tbody>
</table>

<h4 id="misonamingvalidatornameablename"><code class="highlighter-rouge">miso.naming.validator.nameable.name</code></h4>

<table>
  <tbody>
    <tr>
      <td>Option</td>
      <td>Detail</td>
      <td>Allow null</td>
      <td>Allow duplicates</td>
      <td>Custom Regex</td>
      <td>Custom Duplication</td>
    </tr>
    <tr>
      <td>default</td>
      <td>Matches ‘default’ generator, or custom regex</td>
      <td>no</td>
      <td>no</td>
      <td>yes</td>
      <td>yes</td>
    </tr>
    <tr>
      <td>allowany</td>
      <td>Only checks that the name is not null</td>
      <td>yes</td>
      <td>yes</td>
      <td>no</td>
      <td>no</td>
    </tr>
  </tbody>
</table>

<h4 id="misonamingvalidatorsamplealias"><code class="highlighter-rouge">miso.naming.validator.sample.alias</code></h4>

<table>
  <tbody>
    <tr>
      <td>Option</td>
      <td>Detail</td>
      <td>Allow null</td>
      <td>Allow duplicates</td>
      <td>Custom Regex</td>
      <td>Custom Duplication</td>
    </tr>
    <tr>
      <td>default</td>
      <td>Default regex: <code class="highlighter-rouge">([A-z0-9]+)_S([A-z0-9]+)_(.*)</code></td>
      <td>no</td>
      <td>no</td>
      <td>yes</td>
      <td>no</td>
    </tr>
    <tr>
      <td>allowany</td>
      <td>Only checks that the alias is not null</td>
      <td>yes</td>
      <td>yes</td>
      <td>no</td>
      <td>no</td>
    </tr>
    <tr>
      <td>oicr</td>
      <td>Matches ‘oicr’ generator</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
    </tr>
  </tbody>
</table>

<h4 id="misonamingvalidatorlibraryalias"><code class="highlighter-rouge">miso.naming.validator.library.alias</code></h4>

<table>
  <tbody>
    <tr>
      <td>Option</td>
      <td>Detail</td>
      <td>Allow null</td>
      <td>Allow duplicates</td>
      <td>Custom Regex</td>
      <td>Custom Duplication</td>
    </tr>
    <tr>
      <td>default</td>
      <td>Matches ‘default’ generator</td>
      <td>no</td>
      <td>no</td>
      <td>yes</td>
      <td>no</td>
    </tr>
    <tr>
      <td>allowany</td>
      <td>Only checks that the alias is not null</td>
      <td>yes</td>
      <td>yes</td>
      <td>no</td>
      <td>no</td>
    </tr>
    <tr>
      <td>oicr</td>
      <td>Matches ‘oicr’ generator</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
    </tr>
  </tbody>
</table>

<h4 id="misonamingvalidatorprojectshortname"><code class="highlighter-rouge">miso.naming.validator.project.shortName</code></h4>

<table>
  <tbody>
    <tr>
      <td>Option</td>
      <td>Detail</td>
      <td>Allow null</td>
      <td>Allow duplicates</td>
      <td>Custom Regex</td>
      <td>Custom Duplication</td>
    </tr>
    <tr>
      <td>allowany</td>
      <td>Optional field, no format specified</td>
      <td>yes</td>
      <td>yes</td>
      <td>no</td>
      <td>no</td>
    </tr>
    <tr>
      <td>oicr</td>
      <td>3-5 characters, CAPS and numbers only</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
      <td>no</td>
    </tr>
  </tbody>
</table>

<p>If a validator accepts custom regex, it can be configured via <code class="highlighter-rouge">&lt;base property&gt;.regex</code>.
e.g. <code class="highlighter-rouge">miso.naming.validator.nameable.name.regex:.*</code> to allow any name. A custom validator
must be specified for this property to be enabled - the naming scheme’s default validator
will not be altered.</p>

<p>If a validator accepts custom duplication, that can be configured via
<code class="highlighter-rouge">&lt;base property&gt;.duplicates</code>. e.g. <code class="highlighter-rouge">miso.naming.validator.library.alias.duplicates:true</code>
to allow duplicate library aliases. A custom validator must be specified for this
property to be enabled - the naming scheme’s default validator will not be altered.</p>

<p>Existing naming schemes:</p>

<table>
  <thead>
    <tr>
      <th>Naming Scheme</th>
      <th>Used for</th>
      <th>Generation</th>
      <th>Validation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>DefaultEntityNamingScheme</td>
      <td>all</td>
      <td>Uses 3-digit entity identifier (e.g. ‘SAM’ for Sample) + ID</td>
      <td>Matches validation</td>
    </tr>
    <tr>
      <td>AllowAnythingNamingScheme</td>
      <td>all</td>
      <td>Uses Java class name. Not intended for generation purposes</td>
      <td>None</td>
    </tr>
    <tr>
      <td>DefaultSampleNamingScheme</td>
      <td>Samples</td>
      <td>None built in</td>
      <td>TGAC’s standard</td>
    </tr>
    <tr>
      <td>OicrSampleNamingScheme</td>
      <td>Samples</td>
      <td>None built in</td>
      <td>OICR’s standard</td>
    </tr>
    <tr>
      <td>DefaultLibraryNamingScheme</td>
      <td>Libraries</td>
      <td>None built in</td>
      <td>TGAC’s standard</td>
    </tr>
    <tr>
      <td>OicrLibraryNamingScheme</td>
      <td>Libraries</td>
      <td>None built in</td>
      <td>OICR’s standard</td>
    </tr>
  </tbody>
</table>

<p>A Sample alias generator may also be configured via <code class="highlighter-rouge">miso.naming.generator.sample.alias</code></p>

<p>The values used in these options refer to classes in the <code class="highlighter-rouge">uk.ac.bbsrc.tgac.miso.core.service.naming</code>
Java package. To create a new naming scheme option, create a new class in this package that extends 
<code class="highlighter-rouge">MisoNamingScheme&lt;T&gt;</code>. To create a new Sample alias generator, extend <code class="highlighter-rouge">NameGenerator&lt;Sample&gt;</code>.
Extending the functionality to validate and/or generate additional fields is possible, but will
require modifications at the Service layer as well.</p>

<h2 id="setting-up-the-notification-server">Setting Up the Notification Server</h2>
<p>The notification server is a Java daemon that scans the paths containing
sequencer output. It is not required for a functioning MISO install, but
without it, sequencer runs must be added manually. Configuration for
<code class="highlighter-rouge">systemd</code>-based Linux systems is provided here.</p>

<p>Create the default configuration:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>mkdir /srv/notification-server
cp $MISO_SRC/notification-server/service/notification.properties /srv/notification-server
cp $MISO_SRC/notification-server/service/miso-notification.service /etc/systemd/system
</code></pre>
</div>

<p>Edit <code class="highlighter-rouge">notification.properties</code>:</p>

<ol>
  <li>Uncomment necessary <code class="highlighter-rouge">&lt;service&gt;.dataPaths</code> line and add comma-separated paths to instrument directories to scan.</li>
  <li>Replace <code class="highlighter-rouge">localhost:8080</code> with URL to MISO web server.</li>
</ol>

<p>After building and deploying the JAR, start the notification server:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo systemctl daemon-reload
sudo systemctl enable miso-notification.service
sudo systemctl start miso-notification.service
</code></pre>
</div>

<p>The service should start up. You can inspect <code class="highlighter-rouge">stdout</code> in
<code class="highlighter-rouge">/srv/notification-server/notification/notification.log</code> file, and <code class="highlighter-rouge">stderr</code> by
<code class="highlighter-rouge">sudo journalctl -f -u miso-notification</code>.</p>

<h2 id="building-the-applicaton">Building the Applicaton</h2>
<p>Building the application is done by:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>mvn clean package -P external
</code></pre>
</div>

<p>There will be two important build artefacts:</p>

<ul>
  <li><code class="highlighter-rouge">miso-web/target/ROOT.war</code></li>
  <li><code class="highlighter-rouge">notification-server/target/notification-server-*.one-jar.jar</code></li>
</ul>

<h2 id="releasing-and-upgrading">Releasing and Upgrading</h2>

<p>To install or upgrade, perform the following steps:</p>

<ol>
  <li>Backup your existing database.</li>
  <li>Stop Tomcat.</li>
  <li>Migrate the database to the newest version. (Described below.)</li>
  <li>Copy the <code class="highlighter-rouge">ROOT.war</code> from the build to <code class="highlighter-rouge">$CATALINA_HOME/webapps</code>.</li>
  <li>Remove <code class="highlighter-rouge">$CATALINA_HOME/webapps/ROOT</code>.</li>
  <li>Start Tomcat.</li>
  <li>Stop the notification server.</li>
  <li>Copy the <code class="highlighter-rouge">notification-server-*.one-jar.jar</code> to <code class="highlighter-rouge">/srv/notification-server/notification-server.jar</code>.</li>
  <li>Restart the notification server.</li>
</ol>

<h3 id="migrating-the-database">Migrating the database</h3>
<p>Updating the database (or setting it up initially) will apply patches to the database using Flyway using the <code class="highlighter-rouge">ROOT.war</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd ${FLYWAY}
rm -f lib/sqlstore-*.jar
unzip -xjo $CATALINA_HOME/webapps/ROOT.war 'WEB-INF/lib/sqlstore-*.jar' -d lib
./flyway -user=$MISO_DB_USER -password=$MISO_DB_PASS -url=$MISO_DB_URL -outOfOrder=true -locations=classpath:db/migration migrate
</code></pre>
</div>

<h2 id="building-the-docker-image">Building the Docker image</h2>

<p>Pull the tag or snapshot that you want to build and package it:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>export version="0.2.35-SNAPSHOT"
git checkout "tags/${version}"
mvn -P external clean install package 
docker build -t "misolims/miso-lims:${version}" --build-arg version="${version}" --no-cache .
</code></pre>
</div>

<p>Once the build completes, test it by launching it:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker run -p 8090:8080 --name "miso${version}" -t "misolims/miso-lims:${version}"
</code></pre>
</div>

<p>Navigate to http://localhost:8090 and login with the credentials admin:admin.</p>

<p>Once satisfied, push the image to Docker Hub. Note that only members of the <a href="https://hub.docker.com/u/misolims/">misolims</a> organisation can push:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker login
docker push "misolims/miso-lims:${version}"
</code></pre>
</div>


                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="https://github.com/TGAC/miso-lims">MISO</a>

                </div>
            </div>
        </div>

        <script src="/miso-lims/styles/navigation.js"></script>

        
    </body>
</html>
